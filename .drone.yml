---
kind: pipeline
type: ssh
name: Build Hestia for RHEL AMD64

platform:
  os: linux
  arch: amd64
  
server:
  host:
    from_secret: server_address
  user:
    from_secret: username
  ssh_key:
    from_secret: ssh_key

steps:
  - name: Cleanup SOURCES & SPECS folder
    commands:
    - rm -rf ~/rpmbuild/SPECS/* ~/rpmbuild/SOURCES/* ~/rpmbuild/SRPMS/* ~/hestiacp
  - name: Clone HestiaCP
    commands:
    - cd ~ && git clone https://github.com/hestiacp/hestiacp
  - name: Get SPECS & SOURCES
    commands:
    - cp ~/hestiacp/src/rpm/nginx/nginx.conf "$HOME/rpmbuild/SOURCES/nginx.conf"
    - cp ~/hestiacp/src/rpm/nginx/hestia-nginx.spec "$HOME/rpmbuild/SPECS/hestia-nginx.spec"
    - cp ~/hestiacp/src/rpm/nginx/hestia-nginx.service "$HOME/rpmbuild/SOURCES/hestia-nginx.service"
    - wget https://nginx.org/download/nginx-1.24.0.tar.gz "$HOME/rpmbuild/SOURCES/"
  - name: Build source RPMS
    commands:
    - rpmbuild -bs ~/rpmbuild/SPECS/hestia-nginx.spec
  - name: RHEL 8
    commands:
    - mkdir -p ./packages/rhel8/
    - mock -r rocky+epel-8-$(arch) ~/rpmbuild/SRPMS/hestia-nginx-1.24.0-1.el8.src.rpm
    - cp /var/lib/mock/rocky+epel-8-$(arch)/result/*.rpm ./packages/rhel8/
  - name: RHEL 9
    commands:
    - mkdir -p ./packages/rhel9/
    - mock -r rocky+epel-9-$(arch) ~/rpmbuild/SRPMS/hestia-nginx-1.24.0-1.el9.src.rpm
    - cp /var/lib/mock/rocky+epel-9-$(arch)/result/*.rpm ./packages/rhel9/
  - name: scp files
    commands:
    - echo "To do create tar file and scp"
    
trigger:
  event: [ promote ]
  
---
kind: pipeline
type: ssh
name: Build Hestia for RHEL ARM64

platform:
  os: linux
  arch: arm64

steps:
  - name: Cleanup SOURCES & SPECS folder
    commands:
    - rm -rf ~/rpmbuild/SPECS/* ~/rpmbuild/SOURCES/* ~/rpmbuild/SRPMS/* ~/hestiacp
  - name: Clone HestiaCP
    commands:
    - cd ~ && git clone https://github.com/hestiacp/hestiacp
  - name: Get SPECS & SOURCES
    commands:
    - cp ~/hestiacp/src/rpm/nginx/nginx.conf "$HOME/rpmbuild/SOURCES/nginx.conf"
    - cp ~/hestiacp/src/rpm/nginx/hestia-nginx.spec "$HOME/rpmbuild/SPECS/hestia-nginx.spec"
    - cp ~/hestiacp/src/rpm/nginx/hestia-nginx.service "$HOME/rpmbuild/SOURCES/hestia-nginx.service"
    - wget https://nginx.org/download/nginx-1.24.0.tar.gz "$HOME/rpmbuild/SOURCES/"
  - name: Build source RPMS
    commands:
    - rpmbuild -bs ~/rpmbuild/SPECS/hestia-nginx.spec
  - name: RHEL 8
    commands:
    - mkdir -p ./packages/rhel8/
    - mock -r rocky+epel-8-$(arch) ~/rpmbuild/SRPMS/hestia-nginx-1.24.0-1.el8.src.rpm
    - cp /var/lib/mock/rocky+epel-8-$(arch)/result/*.rpm ./packages/rhel8/
  - name: RHEL 9
    commands:
    - mkdir -p ./packages/rhel9/
    - mock -r rocky+epel-9-$(arch) ~/rpmbuild/SRPMS/hestia-nginx-1.24.0-1.el9.src.rpm
    - cp /var/lib/mock/rocky+epel-9-$(arch)/result/*.rpm ./packages/rhel9/
  - name: scp files
    image: appleboy/drone-scp:1.6.4
    settings:
      host:
        from_secret: target_server
      user: root
      key:
        from_secret: ssh_key
      port: 22
      command_timeout: 2m
      target: /root/
      source:
      - ./packages/*
      
trigger:
  event: [ promote ]
    
---
  kind: pipeline
  type: docker
  name: Push
  
  platform:
    os: linux
    arch: amd64
  
  steps:
    - name: Check
      image: alpine/git
      commands:
        - git clone https://github.com/hestiacp/hestiacp.git
        - cd hestiacp
  trigger:
  event: [ push ]

---
kind: pipeline
type: docker
name: Build Hestia for AMD64

platform:
  os: linux
  arch: amd64

steps:
  - name: Ubuntu 22.04
    image: ubuntu:jammy
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/jammy
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/jammy
    - rm -rf /tmp/hestia-src/
  - name: Ubuntu 20.04
    image: ubuntu:focal
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'    
    - mkdir -p ./packages/ubuntu/focal
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/focal
    - rm -rf /tmp/hestia-src/
  - name: Ubuntu 18.04
    image: ubuntu:bionic
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/bionic
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/bionic
    - rm -rf /tmp/hestia-src/
  - name: Debian Bullseye
    image: debian:bullseye
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/bullseye
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/bullseye
    - rm -rf /tmp/hestia-src/
  - name: Debian Buster
    image: debian:buster
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/buster
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/buster
    - rm -rf /tmp/hestia-src/
  - name: Debian Stretch
    image: debian:stretch
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/stretch
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/stretch
    - rm -rf /tmp/hestia-src/
  - name: scp files
    image: appleboy/drone-scp
    settings:
      host:
        from_secret: target_server
      user: root
      key:
        from_secret: ssh_key
      port: 22
      command_timeout: 2m
      target: /root/
      source:
        - ./packages/*
        
trigger:
  event: [ push ]

---
kind: pipeline
type: docker
name: Build Hestia for ARM64

platform:
  os: linux
  arch: arm64

steps:
  - name: Ubuntu 22.04
    image: ubuntu:jammy
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/jammy
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/jammy
    - rm -rf /tmp/hestia-src/
  - name: Ubuntu 20.04
    image: ubuntu:focal
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'    
    - mkdir -p ./packages/ubuntu/focal
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/focal
    - rm -rf /tmp/hestia-src/
  - name: Ubuntu 18.04
    image: ubuntu:bionic
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/bionic
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/bionic
    - rm -rf /tmp/hestia-src/
  - name: Debian Bullseye
    image: debian:bullseye
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/bullseye
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/bullseye
    - rm -rf /tmp/hestia-src/
  - name: Debian Buster
    image: debian:buster
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/buster
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/buster
    - rm -rf /tmp/hestia-src/
  - name: Debian Stretch
    image: debian:stretch
    commands:
    - ln -snf /usr/share/zoneinfo/CET /etc/localtime && echo CET > /etc/timezone
    - ./clone_hestiacp.sh
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --nginx --noinstall --keepbuild --debug '~localsrc'
    - ./hestiacp/src/hst_autocompile.sh --dontinstalldeps --php --noinstall --keepbuild --debug '~localsrc'
    - mkdir -p ./packages/stretch
    - mv /tmp/hestiacp-src/deb/*.deb ./packages/stretch
    - rm -rf /tmp/hestia-src/
  - name: scp files
    image: appleboy/drone-scp
    settings:
      host:
        from_secret: target_server
      user: root
      key:
        from_secret: ssh_key
      port: 22
      command_timeout: 2m
      target: /root/
      source:
        - ./packages/*
        
trigger:
  event: [ push ]
  
---
kind: signature
hmac: 766e7f08151b19d259efa81729bacfd2d7b552c40a1c385e2ee41ec2951f0427
